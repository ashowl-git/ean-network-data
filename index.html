<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>EAN Í≥ÑÏïΩ ÎÑ§Ìä∏ÏõåÌÅ¨</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 25%, #e2e8f0 100%);
            color: #1a202c;
            overflow: hidden;
            line-height: 1.6;
            font-feature-settings: 'liga' 1, 'kern' 1;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .graph-container {
            flex: 1;
            position: relative;
            background: transparent;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(52, 211, 153, 0.02) 0%, transparent 50%);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            text-shadow: none;
            background: transparent;
            padding: 4px 8px;
            border-radius: 6px;
            backdrop-filter: none;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            color: #374151;
            font-size: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(16, 185, 129, 0.6);
            background: transparent;
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.05),
                0 0 0 3px rgba(16, 185, 129, 0.15);
            transform: translateY(-1px);
        }

        .search-input::placeholder {
            color: rgba(107, 114, 128, 0.6);
        }

        /* ÌÉÄÏûÑÎùºÏù∏ Î£∞Îü¨ ÎîîÏûêÏù∏ */
        .timeline-ruler-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .timeline-ruler {
            position: relative;
            height: 60px;
            width: 100%;
            padding: 10px 0;
        }

        .ruler-track {
            position: absolute;
            top: 30px;
            left: 15px;
            right: 15px;
            height: 2px;
            background: linear-gradient(90deg, #e5e7eb 0%, #10b981 50%, #34d399 100%);
            border-radius: 1px;
        }

        .ruler-ticks {
            position: absolute;
            top: 25px;
            left: 15px;
            right: 15px;
            height: 12px;
        }

        .ruler-tick {
            position: absolute;
            width: 1px;
            height: 8px;
            background: #d1d5db;
            transform: translateX(-50%);
        }

        .ruler-tick.major {
            width: 2px;
            height: 12px;
            top: -2px;
            background: #9ca3af;
        }

        .ruler-labels {
            position: absolute;
            top: 5px;
            left: 15px;
            right: 15px;
            height: 20px;
        }

        .ruler-year {
            position: absolute;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            transform: translateX(-50%);
            white-space: nowrap;
            user-select: none;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .ruler-year.selected {
            color: #10b981;
            font-weight: 700;
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .selection-range {
            position: absolute;
            top: 25px;
            left: 15px;
            right: 15px;
            height: 12px;
        }

        .range-fill {
            position: absolute;
            height: 4px;
            top: 4px;
            background: linear-gradient(90deg, #10b981, #34d399);
            border-radius: 2px;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }

        .range-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            top: -4px;
            background: #ffffff;
            border: 3px solid #10b981;
            border-radius: 50%;
            cursor: grab;
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2;
        }

        .range-handle:hover {
            transform: translateX(-50%) scale(1.15);
            border-color: #059669;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .range-handle:active {
            cursor: grabbing;
            transform: translateX(-50%) scale(1.1);
        }

        .range-handle::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .timeline-display {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
        }

        .timeline-period {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .period-label {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .period-range {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 700;
            color: #10b981;
        }

        .period-arrow {
            color: #34d399;
            font-size: 14px;
        }

        .timeline-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            gap: 8px;
        }

        .timeline-stats .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex: 1;
        }

        .timeline-stats .stat-label {
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timeline-stats .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #10b981;
            text-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }


        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            color: #374151;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            backdrop-filter: none;
            position: relative;
            overflow: hidden;
            text-shadow: none;
        }

        .filter-btn:hover {
            background: transparent;
            border-color: rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .filter-btn:hover::before {
            left: 100%;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border-color: rgba(16, 185, 129, 0.3);
            color: #ffffff;
            box-shadow: 
                0 4px 12px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }


        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
            color: #374151;
        }

        .stat-value {
            font-weight: 600;
            color: #34d399;
            text-shadow: 0 0 8px rgba(52, 211, 153, 0.4);
        }


        /* Ïù∏ÎùºÏù∏ Î≤îÎ°Ä ÎîîÏûêÏù∏ */
        .inline-legend {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #6b7280;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 100;
            color: #10b981;
            max-width: 500px;
            padding: 0 20px;
        }

        .loading-text {
            margin-top: 16px;
            line-height: 1.2;
            white-space: nowrap;
        }

        .en-text {
            font-size: 16px;
            font-weight: 600;
            color: #10b981;
            text-shadow: none;
            line-height: 1.4;
        }

        .en-sub-text {
            font-size: 14px;
            font-weight: 400;
            color: #34d399;
            text-shadow: none;
            line-height: 1.3;
        }

        .en-wait {
            font-size: 13px;
            font-weight: 400;
            color: #6b7280;
            text-shadow: none;
        }

        .ko-text {
            font-size: 15px;
            font-weight: 600;
            color: #10b981;
            text-shadow: none;
            line-height: 1.5;
        }

        .ko-sub-text {
            font-size: 14px;
            font-weight: 400;
            color: #34d399;
            text-shadow: none;
            line-height: 1.4;
        }

        .ko-wait {
            font-size: 13px;
            font-weight: 400;
            color: #6b7280;
            text-shadow: none;
        }

        .eco-spinner {
            width: 48px;
            height: 48px;
            margin: 0 auto;
            position: relative;
            animation: eco-pulse 2s ease-in-out infinite;
        }

        .eco-spinner::before {
            content: 'üå±';
            font-size: 32px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: eco-rotate 3s linear infinite;
        }

        .eco-spinner::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid transparent;
            border-top: 2px solid #10b981;
            border-right: 2px solid #34d399;
            border-radius: 50%;
            animation: eco-spin 1.5s linear infinite;
        }

        @keyframes eco-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes eco-rotate {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg) scale(1); }
            25% { transform: translate(-50%, -50%) rotate(90deg) scale(1.1); }
            50% { transform: translate(-50%, -50%) rotate(180deg) scale(1); }
            75% { transform: translate(-50%, -50%) rotate(270deg) scale(1.1); }
        }

        @keyframes eco-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @media (max-width: 768px) {
            .loading {
                max-width: calc(100vw - 40px);
            }
            
            .en-text {
                font-size: 15px;
            }
            
            .en-sub-text {
                font-size: 13px;
            }
            
            .ko-text {
                font-size: 14px;
            }
            
            .ko-sub-text {
                font-size: 13px;
            }
            
            .eco-spinner {
                width: 40px;
                height: 40px;
            }
            
            .eco-spinner::before {
                font-size: 28px;
            }
            
        }

        .node {
            cursor: pointer;
            stroke: none;
            stroke-width: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.15));
            opacity: 0.95;
        }

        .node:hover {
            stroke: none;
            stroke-width: 0;
            filter: drop-shadow(0 6px 20px rgba(0, 0, 0, 0.4)) drop-shadow(0 0 15px rgba(16, 185, 129, 0.6));
            opacity: 1;
        }

        .node.blurred {
            opacity: 0.2;
            filter: blur(1px);
        }

        .node.highlighted {
            opacity: 1;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }

        .link {
            stroke: #10b981;
            stroke-opacity: 0.5;
            stroke-width: 1px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            stroke-linecap: round;
        }

        .link.blurred {
            opacity: 0.1;
        }

        .link.highlighted {
            stroke: #10b981;
            stroke-opacity: 0.95;
            stroke-width: 4px;
            filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.5));
        }

        .node-label {
            font-size: 11px;
            fill: #374151;
            text-anchor: middle;
            pointer-events: none;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(255, 255, 255, 0.3);
        }

        .node-label.visible {
            opacity: 1;
        }

        .node-label.service-highlighted {
            opacity: 1;
            font-size: 12px;
            font-weight: 600;
            fill: #10b981;
            text-shadow: 
                0 0 8px rgba(16, 185, 129, 0.6),
                0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .node.service-selected {
            stroke-width: 4px;
            stroke: #059669;
            filter: drop-shadow(0 3px 8px rgba(16, 185, 129, 0.4));
        }

        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: #374151;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip strong {
            color: #111827;
            font-weight: 600;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 100;
        }

        .zoom-controls-inline {
            display: flex;
            flex-direction: row;
            gap: 4px;
        }

        .zoom-btn {
            width: 48px;
            height: 48px;
            background: transparent;
            backdrop-filter: none;
            border: 1px solid rgba(0, 0, 0, 0.12);
            border-radius: 12px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .zoom-btn:hover {
            background: transparent;
            border-color: rgba(0, 0, 0, 0.2);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn:active {
            transform: translateY(-1px) scale(0.98);
            transition: all 0.1s;
        }

        .clear-selection {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 10px 16px;
            background: rgba(239, 68, 68, 0.9);
            backdrop-filter: none;
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            opacity: 0;
            pointer-events: none;
        }

        .clear-selection.visible {
            opacity: 1;
            pointer-events: all;
        }

        .clear-selection:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* ÌîåÎ°úÌåÖ Ïª®Ìä∏Î°§ Ìå®ÎÑê */
        .floating-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: transparent;
            backdrop-filter: none;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 300px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateZ(0);
        }

        .floating-controls:hover {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px) translateZ(0);
        }

        /* ÌîåÎ°úÌåÖ Ïò§Î≤ÑÎ†àÏù¥ Ïπ¥Îìú */
        .overlay-cards {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .overlay-card {
            background: transparent;
            backdrop-filter: none;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            pointer-events: all;
            width: 300px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateZ(0);
        }

        .overlay-card:hover {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.12);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px) translateZ(0);
        }

        .overlay-card h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #1a202c;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-shadow: none;
        }

        .service-controls {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .service-control-btn {
            padding: 8px 12px;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            color: #374151;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
            backdrop-filter: none;
            position: relative;
            min-height: 36px;
            text-shadow: none;
        }

        .service-control-btn:hover {
            background: transparent;
            border-color: rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .service-control-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border-color: rgba(16, 185, 129, 0.3);
            color: #ffffff;
            box-shadow: 
                0 4px 12px rgba(16, 185, 129, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .service-list {
            max-height: 240px;
            overflow-y: auto;
        }

        .service-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .service-item:last-child {
            border-bottom: none;
        }

        .service-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 8px;
            margin: 0 -8px;
        }

        .service-checkbox {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .service-label {
            flex: 1;
            font-size: 13px;
            color: #374151;
            cursor: pointer;
            line-height: 1.4;
        }

        .service-label.selected {
            font-weight: 600;
            color: #34d399;
            text-shadow: 0 0 8px rgba(52, 211, 153, 0.4);
        }

        .service-count {
            font-size: 11px;
            color: #6b7280;
            background: transparent;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .service-item.highlighted .service-count {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: #ffffff;
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .service-search {
            width: 100%;
            padding: 10px 14px;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            color: #374151;
            font-size: 12px;
            margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .service-search:focus {
            outline: none;
            border-color: rgba(16, 185, 129, 0.6);
            background: transparent;
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.05),
                0 0 0 3px rgba(16, 185, 129, 0.15);
            transform: translateY(-1px);
        }

        .service-search::placeholder {
            color: rgba(107, 114, 128, 0.5);
        }

        /* ÌÑ∞Ïπò Ïù∏ÌÑ∞ÎûôÏÖò ÏµúÏ†ÅÌôî */
        @media (hover: none) and (pointer: coarse) {
            .zoom-btn,
            .filter-btn,
            .service-control-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .node {
                stroke-width: 3px;
            }
            
            .search-input,
            .service-search {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
        @media (max-width: 1200px) {
            .overlay-cards {
                right: 15px;
                gap: 15px;
            }
            
            .overlay-card {
                width: 280px;
            }
            
            .floating-controls {
                width: 280px;
            }
        }
        
        @media (max-width: 992px) {
            .overlay-cards {
                position: fixed;
                top: auto;
                bottom: 80px;
                right: 15px;
                flex-direction: row;
                flex-wrap: wrap;
                max-width: calc(100vw - 30px);
                gap: 12px;
            }
            
            .overlay-card {
                width: 240px;
                max-width: calc(50vw - 20px);
                padding: 16px;
            }
            
            .floating-controls {
                width: 260px;
                padding: 16px;
            }
            
            .zoom-controls {
                bottom: 15px;
                right: 15px;
            }
            
            .zoom-controls-inline {
                gap: 3px;
            }
            
            .zoom-controls-inline .zoom-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: 250px;
                overflow-y: auto;
            }
            
            .container {
                flex-direction: column;
            }
            
            .graph-container {
                height: calc(100vh - 250px);
            }
            
            .zoom-controls {
                top: 15px;
                right: 15px;
                bottom: auto;
            }
            
            .zoom-controls-inline {
                flex-direction: column;
                gap: 2px;
            }
            
            .zoom-controls-inline .zoom-btn {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .service-browser {
                max-height: 150px;
            }
            
            .overlay-cards {
                position: fixed;
                top: auto;
                bottom: 25px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                flex-direction: column;
                align-items: center;
                max-width: calc(100vw - 50px);
                gap: 15px;
            }
            
            .overlay-card {
                width: 100%;
                max-width: 340px;
                padding: 18px;
            }
            
            .floating-controls {
                width: calc(100vw - 50px);
                max-width: 340px;
                padding: 18px;
                gap: 18px;
            }
            
            .zoom-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                height: 160px;
                padding: 15px;
            }
            
            .graph-container {
                height: calc(100vh - 160px);
            }
            
            .control-group {
                margin-bottom: 15px;
            }
            
            .overlay-card {
                padding: 16px;
                width: 100%;
                max-width: 300px;
            }
            
            .floating-controls {
                padding: 16px;
                width: calc(100vw - 32px);
                max-width: 300px;
                gap: 16px;
            }
            
            .overlay-cards {
                bottom: 20px;
                max-width: calc(100vw - 32px);
                gap: 12px;
            }
            
            .zoom-btn {
                width: 48px;
                height: 48px;
            }
            
            .zoom-controls-inline .zoom-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
                min-width: auto;
                min-height: auto;
            }
            
        }

        /* Îã§ÌÅ¨Î™®Îìú ÎåÄÏùë */
        @media (prefers-color-scheme: dark) {
            :root {
                color-scheme: dark;
            }
        }

        /* Ïï†ÎãàÎ©îÏù¥ÏÖò Í∞êÏÜå ÏÑ†Ìò∏ÎèÑ ÎåÄÏùë */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    
.link { vector-effect: non-scaling-stroke; shape-rendering: optimizeSpeed; }
.node-label { pointer-events: none; }
</style>
</head>
<body>
    <div class="container">
        
        <div class="graph-container">
            <div class="loading" id="loading">
                <div class="eco-spinner"></div>
                <div class="loading-text">
                    <span class="en-text">Connecting the network footprints of EAN</span><br>
                    <span class="en-sub-text">Architectural group in environmental, ecological, and energy fields</span><br>
                    <span class="en-wait">Please wait a moment</span><br><br>
                    <span class="ko-text">ÌôòÍ≤Ω¬∑ÏÉùÌÉú¬∑ÏóêÎÑàÏßÄ Î∂ÑÏïº Í±¥Ï∂ïÏù∏ Í∑∏Î£π EANÏùò</span><br>
                    <span class="ko-sub-text">ÎÑ§Ìä∏ÏõåÌÅ¨ Î∞úÏûêÏ∑®Î•º Ïó∞Í≤∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§</span><br>
                    <span class="ko-wait">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</span>
                </div>
            </div>
            
            <!-- ÌîåÎ°úÌåÖ Ïª®Ìä∏Î°§ Ìå®ÎÑê -->
            <div class="floating-controls">
                <div class="control-group">
                    <label>Í≤ÄÏÉâ</label>
                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                        <input type="text" class="search-input" id="searchInput" placeholder="Í≥ÑÏïΩÎ™Ö, ÏàòÌñâÏö©Ïó≠ Í≤ÄÏÉâ..." style="flex: 1;">
                        <div class="zoom-controls-inline">
                            <button class="zoom-btn" id="zoomIn">+</button>
                            <button class="zoom-btn" id="zoomOut">‚àí</button>
                            <button class="zoom-btn" id="resetZoom">‚åÇ</button>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>ÌöåÏÇ¨ Ïó∞ÎåÄÍ∏∞</label>
                    <div class="timeline-ruler-container">
                        <div class="timeline-ruler">
                            <div class="ruler-track"></div>
                            <div class="ruler-ticks"></div>
                            <div class="ruler-labels"></div>
                            <div class="selection-range">
                                <div class="range-handle range-start" data-year="2020"></div>
                                <div class="range-handle range-end" data-year="2024"></div>
                                <div class="range-fill"></div>
                            </div>
                        </div>
                        <div class="timeline-display">
                            <div class="timeline-period">
                                <span class="period-label">EAN Ïó¨Ï†ï</span>
                                <span class="period-range">
                                    <span id="timelineStart">2020</span>
                                    <span class="period-arrow">‚Üí</span>
                                    <span id="timelineEnd">2024</span>
                                </span>
                            </div>
                        </div>
                        
                        <!-- ÌÜµÍ≥Ñ Ï†ïÎ≥¥ Ï∂îÍ∞Ä -->
                        <div class="timeline-stats">
                            <div class="stat-item">
                                <span class="stat-label">Ï¥ù ÎÖ∏Îìú:</span>
                                <span class="stat-value" id="totalNodes">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Ïó∞Í≤∞:</span>
                                <span class="stat-value" id="totalLinks">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">ÌëúÏãúÎêú ÎÖ∏Îìú:</span>
                                <span class="stat-value" id="visibleNodes">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>ÎÖ∏Îìú ÌÉÄÏûÖ</label>
                    <div class="filter-buttons" id="nodeTypeFilters">
                        <button class="filter-btn active" data-type="all">Ï†ÑÏ≤¥</button>
                        <button class="filter-btn" data-type="contract-only">Í≥ÑÏïΩÎ™ÖÎßå</button>
                        <button class="filter-btn" data-type="service-only">ÏàòÌñâÏö©Ïó≠Îßå</button>
                    </div>
                    
                    <!-- Î≤îÎ°Ä Ïù¥Îèô -->
                    <div class="inline-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #3b82f6;"></div>
                            <span>Í≥ÑÏïΩÎ™Ö</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #10b981;"></div>
                            <span>ÏàòÌñâÏö©Ïó≠</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÌîåÎ°úÌåÖ Ïò§Î≤ÑÎ†àÏù¥ Ïπ¥ÎìúÎì§ -->
            <div class="overlay-cards">
                <div class="overlay-card">
                    <h3>
                        ÏàòÌñâÏö©Ïó≠
                        <span id="selectedServiceCount" style="font-size: 12px; color: #6b7280;">0/43</span>
                    </h3>
                    
                    <input type="text" class="service-search" id="serviceSearch" placeholder="ÏàòÌñâÏö©Ïó≠ Í≤ÄÏÉâ...">
                    
                    <div class="service-controls">
                        <button class="service-control-btn" id="selectAllServices">Î™®Îëê ÏÑ†ÌÉù</button>
                        <button class="service-control-btn" id="clearAllServices">Î™®Îëê Ìï¥Ï†ú</button>
                        <button class="service-control-btn" id="showSelectedOnly">ÏÑ†ÌÉùÎßå Î≥¥Í∏∞</button>
                    </div>
                    
                    <div class="service-list" id="serviceList">
                        <!-- ÏàòÌñâÏö©Ïó≠ Î¶¨Ïä§Ìä∏Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                    </div>
                </div>
                
                <!-- Î≤îÎ°ÄÎäî ÎÖ∏ÎìúÌÉÄÏûÖ ÌïòÎã®ÏúºÎ°ú Ïù¥ÎèôÎê® -->
                
            </div>
            
            <!-- Ï§å Ïª®Ìä∏Î°§ÏùÄ Í≤ÄÏÉâ ÏûÖÎ†•Ï∞Ω ÏòÜÏúºÎ°ú Ïù¥ÎèôÎê® -->
            
            <button class="clear-selection" id="clearSelection">ÏÑ†ÌÉù Ìï¥Ï†ú</button>
            
            <svg id="graph"></svg>
            <div class="tooltip" id="tooltip"></div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let allData = [];
        let filteredData = [];
        let nodes = [];
        let links = [];
        let simulation;
        let svg, g;
        let width, height;
        let zoom;
        let selectedNode = null;
        let currentScale = 1;
        let selectedServices = new Set();
        let allServices = [];
        let showSelectedOnly = false;
        let yearRange = { min: 2020, max: 2024 };
        let availableYears = [];

        // ÏÑ±Îä• ÏµúÏ†ÅÌôî Î≥ÄÏàò
        let isSimulationRunning = false;
        let animationFrameId = null;
        let lastUpdateTime = 0;
        let visibleNodes = [];
        let visibleLinks = [];
        let nodeQuadTree = null;
        let performanceMode = false;
        let smartPerformanceMode = false; // ÏßÄÎä•Ìòï ÏÑ±Îä• Î™®Îìú

        // ÏÉâÏÉÅ Ïä§ÌÇ§Îßà (ÎààÏùò ÌîºÎ°ú Í∞êÏÜåÎ•º ÏúÑÌïú Î∂ÄÎìúÎü¨Ïö¥ ÏÉâÏÉÅ)
        const colors = {
            contract: '#3b82f6',    // ÌååÎûÄÏÉâ - Í≥ÑÏïΩÎ™Ö
            service: '#10b981'      // Ï¥àÎ°ùÏÉâ - ÏàòÌñâÏö©Ïó≠
        };

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadData();
                initGraph();
                setupEventListeners();
                updateStats();
            } catch (error) {
                console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ef4444;">‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®</div>
                    <div style="font-size: 12px; margin-top: 10px;">CSV ÌååÏùºÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.</div>
                `;
            }
        });

        // ÏµúÏ†ÅÌôîÎêú Îç∞Ïù¥ÌÑ∞ Î°úÎìú (JSON Ïö∞ÏÑ†, CSV Ìè¥Î∞±)
        async function loadData() {
            try {
                // JSON ÌååÏùº Î°úÎìú ÏãúÎèÑ
                console.log('JSON Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
                const startTime = performance.now();
                
                const response = await fetch('data.json');
                const jsonData = await response.json();
                
                console.log(`JSON Î°úÎìú ÏôÑÎ£å: ${jsonData.records.length.toLocaleString()}Í∞ú Î†àÏΩîÎìú`);
                
                // Ïù∏Îç±Ïä§Î•º Ïã§Ï†ú Í∞íÏúºÎ°ú Î≥ÄÌôò
                allData = jsonData.records.map(record => ({
                    year: jsonData.lookup.years[record[0]],
                    contract: jsonData.lookup.contracts[record[1]], 
                    service: jsonData.lookup.services[record[2]]
                }));
                
                const endTime = performance.now();
                console.log(`JSON ÌååÏã± ÏôÑÎ£å: ${allData.length.toLocaleString()}Í∞ú Ìï≠Î™© (${(endTime - startTime).toFixed(1)}ms)`);
                
            } catch (error) {
                console.warn('JSON Î°úÎìú Ïã§Ìå®, CSVÎ°ú Ìè¥Î∞±:', error);
                // CSV Ìè¥Î∞±
                await loadDataCSV();
            }

            filteredData = [...allData];
            createNetworkData();
            
            // ÌÉÄÏûÑÎùºÏù∏ Î£∞Îü¨ Ï¥àÍ∏∞Ìôî
            initializeTimelineRuler();
            
            // ÏàòÌñâÏö©Ïó≠ Î∏åÎùºÏö∞Ï†Ä Ï¥àÍ∏∞Ìôî
            initializeServiceBrowser();
        }

        // CSV Ìè¥Î∞± Ìï®Ïàò
        async function loadDataCSV() {
            console.log('CSV Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
            const startTime = performance.now();
            
            const response = await fetch('202508_EANÍ≥ÑÏïΩÌòÑÌô©_ÏôÑÏ†ÑÎ≥∏.csv');
            const text = await response.text();
            
            // CSV ÌååÏã±
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');
            
            allData = lines.slice(1).map(line => {
                const values = parseCSVLine(line);
                return {
                    year: values[0]?.trim() || '',
                    contract: values[1]?.trim() || '',
                    service: values[2]?.trim() || ''
                };
            }).filter(d => d.year && d.contract && d.service);

            const endTime = performance.now();
            console.log(`CSV ÌååÏã± ÏôÑÎ£å: ${allData.length.toLocaleString()}Í∞ú Ìï≠Î™© (${(endTime - startTime).toFixed(1)}ms)`);
        }

        // CSV ÎùºÏù∏ ÌååÏã± (Îî∞Ïò¥Ìëú Ï≤òÎ¶¨)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result;
        }

        // ÎÑ§Ìä∏ÏõåÌÅ¨ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Î∞úÏ£ºÏ≤ò Ï†úÍ±∞Îê®)
        function createNetworkData() {
            const nodeMap = new Map();
            const linkMap = new Map();

            // ÎÖ∏Îìú ÏÉùÏÑ±
            filteredData.forEach(d => {
                // Í≥ÑÏïΩÎ™Ö ÎÖ∏Îìú
                if (!nodeMap.has(d.contract)) {
                    nodeMap.set(d.contract, {
                        id: d.contract,
                        type: 'contract',
                        year: d.year,
                        connections: 0
                    });
                }

                // ÏàòÌñâÏö©Ïó≠ ÎÖ∏Îìú
                if (!nodeMap.has(d.service)) {
                    nodeMap.set(d.service, {
                        id: d.service,
                        type: 'service',
                        connections: 0
                    });
                }

                // ÎßÅÌÅ¨ ÏÉùÏÑ± (Í≥ÑÏïΩÎ™Ö - ÏàòÌñâÏö©Ïó≠Îßå)
                const linkId = d.contract < d.service ? `${d.contract}|${d.service}` : `${d.service}|${d.contract}`;
                if (!linkMap.has(linkId)) {
                    linkMap.set(linkId, {
                        source: d.contract,
                        target: d.service,
                        weight: 1
                    });
                    nodeMap.get(d.contract).connections++;
                    nodeMap.get(d.service).connections++;
                } else {
                    linkMap.get(linkId).weight++;
                }
            });

            nodes = Array.from(nodeMap.values());
            links = Array.from(linkMap.values());
        }

        // ÌÉÄÏûÑÎùºÏù∏ Î£∞Îü¨ Ï¥àÍ∏∞Ìôî
        function initializeTimelineRuler() {
            const years = [...new Set(allData.map(d => parseInt(d.year)))].filter(y => !isNaN(y)).sort((a, b) => a - b);
            availableYears = years;
            
            if (years.length === 0) return;
            
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);
            
            // Ï†ÑÏó≠ Î≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏
            yearRange.min = minYear;
            yearRange.max = maxYear;
            
            // Î£∞Îü¨ Î†åÎçîÎßÅ
            setTimeout(() => renderTimelineRuler(minYear, maxYear), 100);
            
            // ÎîîÏä§ÌîåÎ†àÏù¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateTimelineDisplay();
        }
        
        function renderTimelineRuler(minYear, maxYear) {
            const ticksContainer = document.querySelector('.ruler-ticks');
            const labelsContainer = document.querySelector('.ruler-labels');
            
            if (!ticksContainer || !labelsContainer) return;
            
            // Í∏∞Ï°¥ ÏöîÏÜå Ï†úÍ±∞
            ticksContainer.innerHTML = '';
            labelsContainer.innerHTML = '';
            
            const totalYears = maxYear - minYear;
            
            // Ï£ºÏöî ÎààÍ∏àÎßå ÏÉùÏÑ± (ÏãúÏûë, Ï§ëÍ∞ÑÏ†êÎì§, ÎÅù)
            const majorYears = [minYear];
            const yearStep = Math.max(1, Math.floor(totalYears / 4)); // ÏµúÎåÄ 5Í∞ú Íµ¨Í∞Ñ
            for (let i = 1; i < 4; i++) {
                const year = minYear + (yearStep * i);
                if (year < maxYear) majorYears.push(year);
            }
            if (maxYear !== minYear) majorYears.push(maxYear);
            
            // Ï£ºÏöî ÎààÍ∏à ÏÉùÏÑ±
            majorYears.forEach(year => {
                const position = totalYears === 0 ? 50 : ((year - minYear) / totalYears) * 100;
                
                const tick = document.createElement('div');
                tick.className = 'ruler-tick major';
                tick.style.left = `${position}%`;
                ticksContainer.appendChild(tick);
            });
            
            // ÏÑ†ÌÉù Î≤îÏúÑ ÏóÖÎç∞Ïù¥Ìä∏ (ÎùºÎ≤®ÏùÄ Ïó¨Í∏∞ÏÑú ÏÉùÏÑ±)
            updateRangeSelection(minYear, maxYear, minYear, maxYear);
        }
        
        function updateRangeSelection(minYear, maxYear, startYear, endYear) {
            const totalYears = maxYear - minYear;
            const startPos = totalYears === 0 ? 0 : ((startYear - minYear) / totalYears) * 100;
            const endPos = totalYears === 0 ? 100 : ((endYear - minYear) / totalYears) * 100;
            
            const startHandle = document.querySelector('.range-start');
            const endHandle = document.querySelector('.range-end');
            const rangeFill = document.querySelector('.range-fill');
            const labelsContainer = document.querySelector('.ruler-labels');
            
            if (startHandle && endHandle && rangeFill) {
                startHandle.style.left = `${startPos}%`;
                endHandle.style.left = `${endPos}%`;
                startHandle.dataset.year = startYear;
                endHandle.dataset.year = endYear;
                
                rangeFill.style.left = `${startPos}%`;
                rangeFill.style.width = `${Math.max(1, endPos - startPos)}%`;
            }
            
            // Í∏∞Ï°¥ ÎùºÎ≤® Ï†úÍ±∞ ÌõÑ ÏÑ†ÌÉùÎêú ÏãúÏûë/ÎÅù Ïó∞ÎèÑÎßå ÌëúÏãú
            if (labelsContainer) {
                labelsContainer.innerHTML = '';
                
                // ÏãúÏûë Ïó∞ÎèÑ ÎùºÎ≤®
                const startLabel = document.createElement('div');
                startLabel.className = 'ruler-year selected';
                startLabel.textContent = startYear;
                startLabel.style.left = `${startPos}%`;
                startLabel.dataset.year = startYear;
                labelsContainer.appendChild(startLabel);
                
                // ÎÅù Ïó∞ÎèÑ ÎùºÎ≤® (ÏãúÏûëÍ≥º Îã§Î•∏ Í≤ΩÏö∞Îßå)
                if (startYear !== endYear) {
                    const endLabel = document.createElement('div');
                    endLabel.className = 'ruler-year selected';
                    endLabel.textContent = endYear;
                    endLabel.style.left = `${endPos}%`;
                    endLabel.dataset.year = endYear;
                    labelsContainer.appendChild(endLabel);
                }
            }
        }
        
        function updateTimelineDisplay() {
            const startEl = document.getElementById('timelineStart');
            const endEl = document.getElementById('timelineEnd');
            if (startEl) startEl.textContent = yearRange.min;
            if (endEl) endEl.textContent = yearRange.max;
        }

        // Í∑∏ÎûòÌîÑ Ï¥àÍ∏∞Ìôî
        function initGraph() {
  // ‚≠ê Starfield layout tuning parameters
  const STARFIELD = {
    chargeStrength: -1500,
    distanceMin: 60,
    distanceMax: 2000,
    linkDistance: 180,
    linkStrength: 0.4,
    collidePadding: 24,
    collideStrength: 1.0,
    centerStrength: 0.03,
    axisStrength: 0.004,
    alphaDecay: 0.02,
    velocityDecay: 0.38
  };

            const container = document.querySelector('.graph-container');
            width = container.clientWidth;
            height = container.clientHeight;

            svg = d3.select('#graph')
                .attr('width', width)
                .attr('height', height);

            // Ï§å ÏÑ§Ï†ï (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', throttle((event) => {
                    g.attr('transform', event.transform);
                    currentScale = event.transform.k;
                    
                    // ÏßÄÎä•Ìòï ÏÑ±Îä• Î™®Îìú Ï°∞Ï†ï
                    const nodeCount = nodes.length;
                    smartPerformanceMode = nodeCount > 1000;
                    performanceMode = nodeCount > 500 || currentScale < 0.3;
                    
                    // Ìö®Ïú®Ï†ÅÏù∏ ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
                    requestAnimationFrame(() => {
                        updateLabelsVisibility();
                        updateNodeVisibility();
                    });
                }, 16));

            svg.call(zoom);
            g = svg.append('g');

            // ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏÑ§Ï†ï (ÏãúÍ∞ÅÏÑ± Ïö∞ÏÑ†)
            const nodeCount = nodes.length;
            smartPerformanceMode = nodeCount > 2000; // ÏûÑÍ≥ÑÍ∞í Ï¶ùÍ∞Ä
            performanceMode = nodeCount > 1000; // ÏûÑÍ≥ÑÍ∞í Ï¶ùÍ∞Ä
            
            let forceStrength, distanceMax, alphaDecay;
            
            // Ïö∞Ï£ºÏùò Î≥ÑÎì§Ï≤òÎüº ÎÑìÍ≤å Î∂ÑÏÇ∞Îêú ÎÑ§Ìä∏ÏõåÌÅ¨
            if (smartPerformanceMode) {
                forceStrength = -400;
                distanceMax = 500;
                alphaDecay = 0.04;
            } else if (performanceMode) {
                forceStrength = -600;
                distanceMax = 700;
                alphaDecay = 0.03;
            } else {
                forceStrength = -800;
                distanceMax = null;
                alphaDecay = 0.02;
            }
            
            \
simulation = d3.forceSimulation(nodes)
  .force('link', d3.forceLink(links)
    .id(d => d.id)
    .distance(STARFIELD.linkDistance)
    .strength(STARFIELD.linkStrength)
  )
  .force('charge', d3.forceManyBody()
    .strength(STARFIELD.chargeStrength)
    .distanceMin(STARFIELD.distanceMin)
    .distanceMax(STARFIELD.distanceMax)
  )
  .force('center', d3.forceCenter(width / 2, height / 2).strength(STARFIELD.centerStrength))
  .force('collision', d3.forceCollide().radius(d => (d._r || getNodeSize(d)) + STARFIELD.collidePadding)
    .strength(STARFIELD.collideStrength)
  )
  .force('x', d3.forceX(width / 2).strength(STARFIELD.axisStrength))
  .force('y', d3.forceY(height / 2).strength(STARFIELD.axisStrength))
  .alphaDecay(STARFIELD.alphaDecay)
  .alphaMin(0.001)
  .velocityDecay(STARFIELD.velocityDecay);


            renderGraph();
            document.getElementById('loading').style.display = 'none';
        }

        // Í∑∏ÎûòÌîÑ Î†åÎçîÎßÅ (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
        function renderGraph() {
  // Cache node radius to avoid repeated getNodeSize() calls in ticks
  if (Array.isArray(nodes)) {
    nodes.forEach(d => { d._r = (typeof getNodeSize === 'function') ? getNodeSize(d) : (d._r || 6); });
  }

            // Í∏∞Ï°¥ ÏöîÏÜå Ï†úÍ±∞
            g.selectAll('*').remove();

            // ÏÑ±Îä• Î™®Îìú Ï≤¥ÌÅ¨ (ÏãúÍ∞ÅÏÑ± Ïö∞ÏÑ†)
            const nodeCount = nodes.length;
            smartPerformanceMode = nodeCount > 2000;
            performanceMode = nodeCount > 1000;
            
            // ÎßÅÌÅ¨ Í∑∏Î¶¨Í∏∞ (Í∞úÏÑ†Îêú ÏãúÍ∞Å Ìö®Í≥º)
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('class', 'link')
                .attr('stroke-width', d => {
                    if (smartPerformanceMode) {
                        return Math.min(Math.sqrt(d.weight) * 1.0 + 1, 3)
  .style('opacity', 0.5)
;
                    } else if (performanceMode) {
                        return Math.min(Math.sqrt(d.weight) * 1.2 + 1, 4.5);
                    } else {
                        return Math.min(Math.sqrt(d.weight) * 1.3 + 1.5, 6);
                    }
                })
                .style('display', smartPerformanceMode && currentScale < 0.1 ? 'none' : null);

            // ÎÖ∏Îìú Í∑∏Î¶¨Í∏∞ (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
            const node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter().append('circle')
                .attr('class', 'node')
                .attr('r', d => getNodeSize(d))
                .attr('fill', d => colors[d.type])
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
  .on('mouseover', (event, d) => {
    g.selectAll('.node-label')
      .filter(l => l.id === d.id)
      .classed('visible', true)
      .classed('hovered', true);
  })
  .on('mouseout', (event, d) => {
    g.selectAll('.node-label')
      .filter(l => l.id === d.id)
      .classed('hovered', false)
      .classed('visible', l => l.type === 'service');
  })
;

            // ÎùºÎ≤® Ï∂îÍ∞Ä (ÏãúÍ∞ÅÏÑ± Ïö∞ÏÑ†)
            const label = g.append('g')
                .selectAll('text')
                .data(nodes.filter(d => d.type === 'service'))
                .enter().append('text')
                .attr('class', 'node-label')
                .attr('dy', d => getNodeSize(d) + 18)
                .text(d => {
                    const maxLength = smartPerformanceMode ? 15 : (performanceMode ? 20 : 25)
  .classed('vis
  // Lazy label creation for non-service nodes
  const createdLabelIds = new Set();
  g.selectAll('.node-label').each(function(d){ if (d && d.id) createdLabelIds.add(d.id); });

  function ensureLabelFor(nodeDatum) {
    if (!nodeDatum || !nodeDatum.id) return;
    if (createdLabelIds.has(nodeDatum.id)) {
      // already exists
      return;
    }
    const maxLength = smartPerformanceMode ? 15 : (performanceMode ? 20 : 30);
    g.append('text')
      .datum(nodeDatum)
      .attr('class', 'node-label')
      .attr('dy', (nodeDatum._r || getNodeSize(nodeDatum)) + 18)
      .text(truncateText(nodeDatum.id, maxLength))
      .classed('visible', true);
    createdLabelIds.add(nodeDatum.id);
  }
ible', d => d.type === 'service');
                    return truncateText(d.id, maxLength);
                })
                .style('display', smartPerformanceMode && currentScale < 0.2 ? 'none' : null);

            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            node
                .on('mouseover', (event, d) => {
                    showTooltip(event, d);
                })
                .on('mouseout', () => {
                    hideTooltip();
                })
                .on('click', (event, d) => {
                    event.stopPropagation();
                    selectNode(d);
                });

            // Î∞∞Í≤Ω ÌÅ¥Î¶≠ Ïãú ÏÑ†ÌÉù Ìï¥Ï†ú
            svg.on('click', () => {
                clearSelection();
            });

            // ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏóÖÎç∞Ïù¥Ìä∏
            simulation.nodes(nodes);
            simulation.force('link').links(links);

            simulation.on('tick', () => {
                const now = Date.now();
                if (now - lastUpdateTime < 16) return; // 60fps Ï†úÌïú
                lastUpdateTime = now;

                // Î∑∞Ìè¨Ìä∏ ÎÇ¥ ÏöîÏÜåÎßå ÏóÖÎç∞Ïù¥Ìä∏
                updateVisibleElements();

                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            // ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûë (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
            isSimulationRunning = true;
            simulation.alpha(performanceMode ? 0.8 : 1).restart();
            
            // ÏÑ±Îä• Î™®ÎìúÏóêÏÑú ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏûêÎèô Ï§ëÏßÄ
            if (performanceMode) {
                setTimeout(() => {
                    if (simulation.alpha() < 0.1) {
                        simulation.stop();
                        isSimulationRunning = false;
                    }
                }, 3000);
            }

            // Ï¥àÍ∏∞ Î™®Îìú ÏÑ§Ï†ï
            updateNodeVisibility();
            updateLabelsVisibility();
        }

        // ÎÖ∏Îìú ÌÅ¨Í∏∞ Í≥ÑÏÇ∞ (Í∞úÏÑ†Îêú Í∑†Ìòï)
        function getNodeSize(d) {
            // ÏßÄÎä•Ìòï ÌÅ¨Í∏∞ Ï°∞Ï†ï
            let baseSize, maxSize, connectionFactor;
            
            if (smartPerformanceMode && nodes.length > 1000) {
                // Í∑πÎåÄ Îç∞Ïù¥ÌÑ∞ Î™®Îìú
                baseSize = 4;
                maxSize = 18;
                connectionFactor = Math.sqrt(d.connections) * 1.2;
            } else if (performanceMode) {
                // ÏùºÎ∞ò ÏÑ±Îä• Î™®Îìú - ÏãúÍ∞ÅÏ†Å ÌíàÏßà Í∞úÏÑ†
                baseSize = 7;
                maxSize = 28;
                connectionFactor = Math.sqrt(d.connections) * 1.5;
            } else {
                // ÏùºÎ∞ò Î™®Îìú
                baseSize = 8;
                maxSize = 35;
                connectionFactor = Math.sqrt(d.connections) * 1.8;
            }
            
            return Math.max(baseSize, Math.min(baseSize + connectionFactor, maxSize));
        }

        // ÎÖ∏Îìú ÏÑ†ÌÉù Î∞è Î∏îÎü¨ Ìö®Í≥º
        function selectNode(targetNode) {
            selectedNode = targetNode;
            
            // Ïó∞Í≤∞Îêú ÎÖ∏ÎìúÎì§ Ï∞æÍ∏∞
            const connectedNodes = new Set([targetNode.id]);
            const connectedLinks = new Set();
            
            links.forEach(link => {
                if (link.source.id === targetNode.id || link.target.id === targetNode.id) {
                    connectedNodes.add(link.source.id);
                    connectedNodes.add(link.target.id);
                    connectedLinks.add(link);
                }
            });

            // ÎÖ∏Îìú Ïä§ÌÉÄÏùº Ï†ÅÏö©
            g.selectAll('.node')
                .classed('blurred', d => !connectedNodes.has(d.id))
                .classed('highlighted', d => connectedNodes.has(d.id));

            // ÎßÅÌÅ¨ Ïä§ÌÉÄÏùº Ï†ÅÏö©
            g.selectAll('.link')
                .classed('blurred', d => !connectedLinks.has(d))
                .classed('highlighted', d => connectedLinks.has(d));

            // ÏÑ†ÌÉù Ìï¥Ï†ú Î≤ÑÌäº ÌëúÏãú
            document.getElementById('clearSelection').classList.add('visible');
        }

        // ÏÑ†ÌÉù Ìï¥Ï†ú (ÏàòÌñâÏö©Ïó≠ ÏÑ†ÌÉùÎèÑ Ìï¥Ï†ú)
        function clearSelection() {
            selectedNode = null;
            
            // ÏàòÌñâÏö©Ïó≠ ÏÑ†ÌÉùÎèÑ Ìï¥Ï†ú
            selectedServices.clear();
            showSelectedOnly = false;
            document.getElementById('showSelectedOnly').classList.remove('active');
            document.getElementById('showSelectedOnly').textContent = 'ÏÑ†ÌÉùÎßå Î≥¥Í∏∞';
            
            g.selectAll('.node')
                .classed('blurred', false)
                .classed('highlighted', false)
                .classed('service-selected', false)
                .style('display', null);

            g.selectAll('.link')
                .classed('blurred', false)
                .classed('highlighted', false)
                .style('display', null);
                
            g.selectAll('.node-label')
                .classed('service-highlighted', false);

            document.getElementById('clearSelection').classList.remove('visible');
            
            // ÏàòÌñâÏö©Ïó≠ Î∏åÎùºÏö∞Ï†Ä ÏóÖÎç∞Ïù¥Ìä∏
            updateServiceCount();
            renderServiceList();
        }

        // ÏÑ±Îä• ÏµúÏ†ÅÌôî Ìó¨Ìçº Ìï®Ïàò
        function throttle(func, delay) {
            let timeoutId;
            let lastExecTime = 0;
            return function (...args) {
                const currentTime = Date.now();
                
                if (currentTime - lastExecTime > delay) {
                    func.apply(this, args);
                    lastExecTime = currentTime;
                } else {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                        lastExecTime = Date.now();
                    }, delay);
                }
            };
        }

        // Î∑∞Ìè¨Ìä∏ ÎÇ¥ ÏöîÏÜåÎßå ÏóÖÎç∞Ïù¥Ìä∏
        function updateVisibleElements() {
            if (!g) return;
            
            const transform = d3.zoomTransform(svg.node());
            const viewBox = {
                x: -transform.x / transform.k,
                y: -transform.y / transform.k,
                width: width / transform.k,
                height: height / transform.k
            };

            // Î∑∞Ìè¨Ìä∏ ÎÇ¥ ÎÖ∏Îìú ÌïÑÌÑ∞ÎßÅ (ÏÑ±Îä• Î™®ÎìúÏùº ÎïåÎßå)
            if (performanceMode) {
                visibleNodes = nodes.filter(d => 
                    d.x >= viewBox.x - 50 && 
                    d.x <= viewBox.x + viewBox.width + 50 &&
                    d.y >= viewBox.y - 50 && 
                    d.y <= viewBox.y + viewBox.height + 50
                );
            } else {
                visibleNodes = nodes;
            }
        }

        // ÎÖ∏Îìú Í∞ÄÏãúÏÑ± ÏóÖÎç∞Ïù¥Ìä∏ (ÏãúÍ∞ÅÏÑ± Ïö∞ÏÑ†)
        function updateNodeVisibility() {
            if (!g) return;

            const nodeSelection = g.selectAll('.node');
  nodeSelection.style('opacity', d => d.connections > 0 ? 0.95 : 0.6);
            const linkSelection = g.selectAll('.link');
  linkSelection.style('opacity', 0.4);
            const labelSelection = g.selectAll('.node-label');

            // ÎåÄÎ∂ÄÎ∂ÑÏùò Í≤ΩÏö∞ Î™®Îì† ÎÖ∏Îìú ÌëúÏãú
            if (smartPerformanceMode && currentScale < 0.1) {
                // Í∑πÎèÑÎ°ú Ï∂ïÏÜåÎêú Í≤ΩÏö∞ÏóêÎßå ÏùºÎ∂Ä Ï†úÌïú
                nodeSelection.style('display', null);
                linkSelection.style('display', null);
                labelSelection.style('display', null);
            } else if (currentScale < 0.2) {
                // ÎßéÏù¥ Ï∂ïÏÜå: Ï§ëÏöî ÎÖ∏Îìú ÏúÑÏ£º
                nodeSelection.style('display', null);
                linkSelection.style('display', null);
                labelSelection.style('display', null);
            } else {
                // ÏùºÎ∞òÏ†ÅÏù∏ Í≤ΩÏö∞: Î™®Îì† ÏöîÏÜå ÌëúÏãú
                nodeSelection.style('display', null);
                linkSelection.style('display', null);
                updateLabelsVisibility();
            }
        }

        // ÎùºÎ≤® ÌëúÏãú (ÏãúÍ∞ÅÏÑ± Ïö∞ÏÑ†)
        function updateLabelsVisibility() {
  // Keep service labels visible
  g.selectAll('.node-label').each(function(d){
    const sel = d3.select(this);
    if (d && d.type === 'service') sel.classed('visible', true);
  });
});
});
        }

        // ÌÖçÏä§Ìä∏ ÏûêÎ•¥Í∏∞
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Ìà¥ÌåÅ ÌëúÏãú
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            const rect = document.querySelector('.graph-container').getBoundingClientRect();
            
            tooltip.innerHTML = `
                <strong>${d.id}</strong><br>
                ÌÉÄÏûÖ: ${getTypeLabel(d.type)}<br>
                Ïó∞Í≤∞: ${d.connections}Í∞ú
                ${d.year ? `<br>Ïó∞ÎèÑ: ${d.year}` : ''}
            `;
            
            tooltip.style.left = (event.clientX - rect.left + 10) + 'px';
            tooltip.style.top = (event.clientY - rect.top - 10) + 'px';
            tooltip.classList.add('visible');
        }

        // Ìà¥ÌåÅ Ïà®Í∏∞Í∏∞
        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        // ÌÉÄÏûÖ ÎùºÎ≤® Î∞òÌôò
        function getTypeLabel(type) {
            const labels = {
                contract: 'Í≥ÑÏïΩÎ™Ö',
                service: 'ÏàòÌñâÏö©Ïó≠'
            };
            return labels[type] || type;
        }

        // ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏ (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
        function dragstarted(event, d) {
            if (!event.active && !isSimulationRunning) {
                simulation.alphaTarget(0.3).restart();
                isSimulationRunning = true;
            }
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) {
                simulation.alphaTarget(0);
                // ÏÑ±Îä• Î™®ÎìúÏóêÏÑú Îπ†Î•∏ Ï¢ÖÎ£å
                if (performanceMode) {
                    setTimeout(() => {
                        simulation.stop();
                        isSimulationRunning = false;
                    }, 1000);
                }
            }
            d.fx = null;
            d.fy = null;
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {
            // Í≤ÄÏÉâ (ÏàòÌñâÏö©Ïó≠ ÌïÑÌÑ∞ÏôÄ Ïó∞Îèô)
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                
                // ÏàòÌñâÏö©Ïó≠ Í≤ÄÏÉâ Í≤∞Í≥ºÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                if (query) {
                    // Í≤ÄÏÉâÏñ¥ÏôÄ Îß§Ïπ≠ÎêòÎäî ÏàòÌñâÏö©Ïó≠ ÏûêÎèô ÌïòÏù¥ÎùºÏù¥Ìä∏
                    const matchingServices = allServices.filter(service => 
                        service.toLowerCase().includes(query)
                    );
                    
                    if (matchingServices.length > 0 && matchingServices.length <= 3) {
                        // Îß§Ïπ≠ÎêòÎäî ÏàòÌñâÏö©Ïó≠Ïù¥ 3Í∞ú Ïù¥ÌïòÎ©¥ ÏûêÎèô ÏÑ†ÌÉù
                        selectedServices.clear();
                        matchingServices.forEach(service => selectedServices.add(service));
                        updateServiceHighlighting();
                        updateServiceCount();
                        renderServiceList();
                    }
                } else {
                    // Í≤ÄÏÉâÏñ¥Í∞Ä ÎπÑÏñ¥ÏûàÏúºÎ©¥ ÏàòÌñâÏö©Ïó≠ ÏÑ†ÌÉù Ìï¥Ï†ú
                    if (selectedServices.size > 0) {
                        selectedServices.clear();
                        updateServiceHighlighting();
                        updateServiceCount();
                        renderServiceList();
                    }
                }
                
                applyFilters();
            });

            // ÌÉÄÏûÑÎùºÏù∏ Î£∞Îü¨ ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏
            let isDragging = false;
            let dragTarget = null;
            
            // ÎìúÎûòÍ∑∏ ÏãúÏûë
            document.addEventListener('mousedown', (e) => {
                const handle = e.target.closest('.range-handle');
                if (handle) {
                    isDragging = true;
                    dragTarget = handle;
                    e.preventDefault();
                }
            });
            
            // ÎìúÎûòÍ∑∏ Ï§ë
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !dragTarget) return;
                
                const ruler = document.querySelector('.timeline-ruler');
                if (!ruler) return;
                
                const rect = ruler.getBoundingClientRect();
                const x = e.clientX - rect.left - 15; // 15px padding
                const width = rect.width - 30; // ÏñëÏ™Ω padding Ï†úÏô∏
                const percentage = Math.max(0, Math.min(100, (x / width) * 100));
                
                const minYear = Math.min(...availableYears);
                const maxYear = Math.max(...availableYears);
                const totalYears = maxYear - minYear;
                const selectedYear = Math.round(minYear + (percentage / 100) * totalYears);
                
                if (dragTarget.classList.contains('range-start')) {
                    yearRange.min = Math.max(minYear, Math.min(selectedYear, yearRange.max));
                } else {
                    yearRange.max = Math.min(maxYear, Math.max(selectedYear, yearRange.min));
                }
                
                updateRangeSelection(minYear, maxYear, yearRange.min, yearRange.max);
                updateTimelineDisplay();
                applyFilters();
            });
            
            // ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å
            document.addEventListener('mouseup', () => {
                isDragging = false;
                dragTarget = null;
            });
            

            // ÎÖ∏Îìú ÌÉÄÏûÖ ÌïÑÌÑ∞ (ÏàòÏ†ïÎê® - Î∞úÏ£ºÏ≤ò Ï†úÍ±∞)
            document.getElementById('nodeTypeFilters').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('#nodeTypeFilters .filter-btn').forEach(btn => 
                        btn.classList.remove('active')
                    );
                    e.target.classList.add('active');
                    applyFilters();
                }
            });

            // Ï§å Ïª®Ìä∏Î°§
            document.getElementById('zoomIn').addEventListener('click', () => {
                svg.transition().duration(performanceMode ? 200 : 500).call(zoom.scaleBy, 1.2);
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                svg.transition().duration(performanceMode ? 200 : 500).call(zoom.scaleBy, 0.8);
            });

            document.getElementById('resetZoom').addEventListener('click', () => {
                // ÏÑ±Îä• Î™®ÎìúÎäî ÎÖ∏Îìú ÏàòÏóê Îî∞Îùº ÏûêÎèô Í≤∞Ï†ïÎêòÎèÑÎ°ù Ïú†ÏßÄ
                svg.transition().duration(800).call(zoom.transform, d3.zoomIdentity);
                setTimeout(() => updateNodeVisibility(), 1000);
            });

            // ÏÑ†ÌÉù Ìï¥Ï†ú Î≤ÑÌäº
            document.getElementById('clearSelection').addEventListener('click', () => {
                clearSelection();
            });

            // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à (ÏÑ±Îä• ÏµúÏ†ÅÌôî)
            window.addEventListener('resize', throttle(() => {
                const container = document.querySelector('.graph-container');
                width = container.clientWidth;
                height = container.clientHeight;
                
                svg.attr('width', width).attr('height', height);
                simulation.force('center', d3.forceCenter(width / 2, height / 2));
                
                if (!isSimulationRunning) {
                    simulation.alpha(0.1).restart();
                    isSimulationRunning = true;
                    setTimeout(() => {
                        simulation.stop();
                        isSimulationRunning = false;
                    }, 1000);
                }
            }, 250));
        }

        // ÌïÑÌÑ∞ Ï†ÅÏö©
        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const activeType = document.querySelector('#nodeTypeFilters .filter-btn.active')?.dataset.type;

            // Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
            filteredData = allData.filter(d => {
                const matchesSearch = !searchQuery || 
                    d.contract.toLowerCase().includes(searchQuery) ||
                    d.service.toLowerCase().includes(searchQuery);

                const year = parseInt(d.year);
                const matchesYear = !isNaN(year) && year >= yearRange.min && year <= yearRange.max;

                return matchesSearch && matchesYear;
            });

            // ÎÑ§Ìä∏ÏõåÌÅ¨ Îç∞Ïù¥ÌÑ∞ Ïû¨ÏÉùÏÑ±
            createNetworkData();

            // ÎÖ∏Îìú ÌÉÄÏûÖ ÌïÑÌÑ∞ÎßÅ
            if (activeType !== 'all') {
                let allowedTypes = [];
                
                switch(activeType) {
                    case 'contract-only':
                        allowedTypes = ['contract'];
                        break;
                    case 'service-only':
                        allowedTypes = ['service'];
                        break;
                }
                
                nodes = nodes.filter(node => allowedTypes.includes(node.type));
                links = links.filter(link => {
                    const sourceNode = nodes.find(n => n.id === link.source);
                    const targetNode = nodes.find(n => n.id === link.target);
                    return sourceNode && targetNode;
                });
            }

            // ÏÑ†ÌÉù Ìï¥Ï†ú
            clearSelection();

            // Í∑∏ÎûòÌîÑ Ïû¨Î†åÎçîÎßÅ
            renderGraph();
            updateStats();
        }

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        function updateStats() {
            document.getElementById('totalNodes').textContent = nodes.length.toLocaleString();
            document.getElementById('totalLinks').textContent = links.length.toLocaleString();
            document.getElementById('visibleNodes').textContent = nodes.length.toLocaleString();
        }

        // ÏàòÌñâÏö©Ïó≠ Î∏åÎùºÏö∞Ï†Ä Ï¥àÍ∏∞Ìôî
        function initializeServiceBrowser() {
            // Î™®Îì† ÏàòÌñâÏö©Ïó≠ Ï∂îÏ∂ú Î∞è Ï†ïÎ†¨
            const serviceSet = new Set();
            allData.forEach(d => {
                if (d.service && d.service.trim()) {
                    serviceSet.add(d.service.trim());
                }
            });
            
            allServices = Array.from(serviceSet).sort((a, b) => a.localeCompare(b, 'ko'));
            
            console.log(`ÏàòÌñâÏö©Ïó≠ ${allServices.length}Í∞ú Ï∂îÏ∂ú ÏôÑÎ£å:`, allServices);
            
            // ÏàòÌñâÏö©Ïó≠ Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
            renderServiceList();
            
            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
            setupServiceBrowserEvents();
            
            // Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateServiceCount();
        }

        // ÏàòÌñâÏö©Ïó≠ Î¶¨Ïä§Ìä∏ Î†åÎçîÎßÅ
        function renderServiceList(searchQuery = '') {
            const serviceList = document.getElementById('serviceList');
            const filteredServices = allServices.filter(service => 
                service.toLowerCase().includes(searchQuery.toLowerCase())
            );
            
            serviceList.innerHTML = '';
            
            filteredServices.forEach(service => {
                // Ìï¥Îãπ ÏàòÌñâÏö©Ïó≠Í≥º Ïó∞Í≤∞Îêú Í≥ÑÏïΩ Ïàò Í≥ÑÏÇ∞
                const contractCount = allData.filter(d => d.service === service).length;
                
                const serviceItem = document.createElement('div');
                serviceItem.className = 'service-item';
                serviceItem.innerHTML = `
                    <input type="checkbox" class="service-checkbox" data-service="${service}" ${selectedServices.has(service) ? 'checked' : ''}>
                    <span class="service-label ${selectedServices.has(service) ? 'selected' : ''}">${service}</span>
                    <span class="service-count">${contractCount}</span>
                `;
                
                if (selectedServices.has(service)) {
                    serviceItem.classList.add('highlighted');
                }
                
                serviceList.appendChild(serviceItem);
            });
        }

        // ÏàòÌñâÏö©Ïó≠ Î∏åÎùºÏö∞Ï†Ä Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        function setupServiceBrowserEvents() {
            // Í≤ÄÏÉâ Í∏∞Îä•
            const serviceSearch = document.getElementById('serviceSearch');
            serviceSearch.addEventListener('input', (e) => {
                const query = e.target.value;
                renderServiceList(query);
                
                // Í≤ÄÏÉâ Í≤∞Í≥ºÏóê Îî∞Î•∏ ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî ÏóÖÎç∞Ïù¥Ìä∏
                const matchingCount = allServices.filter(service => 
                    service.toLowerCase().includes(query.toLowerCase())
                ).length;
                
                if (query && matchingCount === 0) {
                    e.target.style.borderColor = '#ef4444';
                    e.target.placeholder = 'ÏùºÏπòÌïòÎäî ÏàòÌñâÏö©Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§';
                } else {
                    e.target.style.borderColor = query ? '#10b981' : '#d1d5db';
                    e.target.placeholder = query ? `${matchingCount}Í∞ú ÏàòÌñâÏö©Ïó≠ Î∞úÍ≤¨` : 'ÏàòÌñâÏö©Ïó≠ Í≤ÄÏÉâ...';
                }
            });

            // Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ)
            const serviceList = document.getElementById('serviceList');
            serviceList.addEventListener('change', (e) => {
                if (e.target.classList.contains('service-checkbox')) {
                    const service = e.target.dataset.service;
                    const isChecked = e.target.checked;
                    
                    if (isChecked) {
                        selectedServices.add(service);
                    } else {
                        selectedServices.delete(service);
                    }
                    
                    updateServiceHighlighting();
                    updateServiceCount();
                    renderServiceList(serviceSearch.value);
                }
            });

            // ÎùºÎ≤® ÌÅ¥Î¶≠ÏúºÎ°ú Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÜ†Í∏Ä
            serviceList.addEventListener('click', (e) => {
                if (e.target.classList.contains('service-label')) {
                    const checkbox = e.target.parentElement.querySelector('.service-checkbox');
                    checkbox.click();
                }
            });

            // Ïª®Ìä∏Î°§ Î≤ÑÌäºÎì§
            document.getElementById('selectAllServices').addEventListener('click', () => {
                allServices.forEach(service => selectedServices.add(service));
                updateServiceHighlighting();
                updateServiceCount();
                renderServiceList(serviceSearch.value);
            });

            document.getElementById('clearAllServices').addEventListener('click', () => {
                selectedServices.clear();
                updateServiceHighlighting();
                updateServiceCount();
                renderServiceList(serviceSearch.value);
            });

            document.getElementById('showSelectedOnly').addEventListener('click', (e) => {
                showSelectedOnly = !showSelectedOnly;
                e.target.classList.toggle('active');
                e.target.textContent = showSelectedOnly ? 'Î™®Îëê Î≥¥Í∏∞' : 'ÏÑ†ÌÉùÎßå Î≥¥Í∏∞';
                updateServiceHighlighting();
            });
        }

        // ÏÑ†ÌÉùÎêú ÏàòÌñâÏö©Ïó≠ Ïàò ÏóÖÎç∞Ïù¥Ìä∏
        function updateServiceCount() {
            const count = selectedServices.size;
            const total = allServices.length;
            document.getElementById('selectedServiceCount').textContent = `${count}/${total}`;
        }

        // ÏàòÌñâÏö©Ïó≠ ÏÑ†ÌÉùÏóê Îî∞Î•∏ Í∑∏ÎûòÌîÑ ÌïòÏù¥ÎùºÏù¥ÌåÖ
        function updateServiceHighlighting() {
            if (!g) return; // Í∑∏ÎûòÌîÑÍ∞Ä ÏïÑÏßÅ Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞

            // ÏÑ†ÌÉùÎêú ÏàòÌñâÏö©Ïó≠Ïù¥ ÏóÜÏúºÎ©¥ Î™®Îì† ÎÖ∏ÎìúÎ•º Ï†ïÏÉÅ ÏÉÅÌÉúÎ°ú
            if (selectedServices.size === 0) {
                g.selectAll('.node')
                    .classed('blurred', false)
                    .classed('highlighted', false)
                    .classed('service-selected', false);
                
                g.selectAll('.link')
                    .classed('blurred', false)
                    .classed('highlighted', false);
                    
                g.selectAll('.node-label')
                    .classed('service-highlighted', false);
                
                return;
            }

            // ÏÑ†ÌÉùÎêú ÏàòÌñâÏö©Ïó≠Í≥º Í¥ÄÎ†®Îêú ÎÖ∏ÎìúÎì§ Ï∞æÍ∏∞
            const selectedServiceNodes = new Set();
            const connectedContractNodes = new Set();
            const highlightedLinks = new Set();

            // ÏÑ†ÌÉùÎêú ÏàòÌñâÏö©Ïó≠ ÎÖ∏ÎìúÎì§Í≥º Ïó∞Í≤∞Îêú Í≥ÑÏïΩÎì§ Ï∞æÍ∏∞
            nodes.forEach(node => {
                if (node.type === 'service' && selectedServices.has(node.id)) {
                    selectedServiceNodes.add(node.id);
                }
            });

            // ÎßÅÌÅ¨Î•º ÌÜµÌï¥ Ïó∞Í≤∞Îêú Í≥ÑÏïΩÎì§ Ï∞æÍ∏∞
            links.forEach(link => {
                const sourceId = typeof link.source === 'object' ? link.source.id : link.source;
                const targetId = typeof link.target === 'object' ? link.target.id : link.target;
                
                if (selectedServiceNodes.has(sourceId)) {
                    connectedContractNodes.add(targetId);
                    highlightedLinks.add(link);
                } else if (selectedServiceNodes.has(targetId)) {
                    connectedContractNodes.add(sourceId);
                    highlightedLinks.add(link);
                }
            });

            // Î™®Îì† Í¥ÄÎ†® ÎÖ∏ÎìúÎì§ÏùÑ Ìï©ÏπòÍ∏∞
            const allRelatedNodes = new Set([...selectedServiceNodes, ...connectedContractNodes]);

            // "ÏÑ†ÌÉùÎßå Î≥¥Í∏∞" Î™®Îìú Ï≤òÎ¶¨
            if (showSelectedOnly) {
                g.selectAll('.node')
                    .style('display', d => allRelatedNodes.has(d.id) ? null : 'none');
                
                g.selectAll('.link')
                    .style('display', d => highlightedLinks.has(d) ? null : 'none');
            } else {
                // Î™®Îì† ÎÖ∏ÎìúÎ•º Îã§Ïãú ÌëúÏãú
                g.selectAll('.node')
                    .style('display', null);
                
                g.selectAll('.link')
                    .style('display', null);
                
                // ÌïòÏù¥ÎùºÏù¥ÌåÖ Ï†ÅÏö©
                g.selectAll('.node')
                    .classed('blurred', d => !allRelatedNodes.has(d.id))
                    .classed('highlighted', d => allRelatedNodes.has(d.id))
                    .classed('service-selected', d => selectedServiceNodes.has(d.id));
                
                g.selectAll('.link')
                    .classed('blurred', d => !highlightedLinks.has(d))
                    .classed('highlighted', d => highlightedLinks.has(d));
            }

            // ÏÑ†ÌÉùÎêú ÏàòÌñâÏö©Ïó≠Í≥º Ïó∞Í≤∞Îêú ÎÖ∏ÎìúÎì§Ïùò ÎùºÎ≤®ÏùÑ Í∞ïÏ°∞
            g.selectAll('.node-label')
                .classed('service-highlighted', d => allRelatedNodes.has(d.id));
                
            // ÏÑ†ÌÉù Ìï¥Ï†ú Î≤ÑÌäº ÌëúÏãú
            document.getElementById('clearSelection').classList.add('visible');
        }
    </script>
</body>
</html>